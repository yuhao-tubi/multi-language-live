<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SRS Multi-Process Pipeline Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .player-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .player-section h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .player-description {
      color: #666;
      margin-bottom: 20px;
      font-size: 0.95rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 10px;
    }

    .badge-success {
      background: #10b981;
      color: white;
    }

    .badge-info {
      background: #3b82f6;
      color: white;
    }

    video {
      width: 100%;
      max-width: 800px;
      border-radius: 8px;
      background: #000;
      display: block;
      margin: 0 auto;
    }

    .info-box {
      background: #f0f9ff;
      border-left: 4px solid #3b82f6;
      padding: 15px 20px;
      margin-bottom: 30px;
      border-radius: 4px;
    }

    .info-box h3 {
      color: #1e40af;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .info-box ul {
      list-style: none;
      padding-left: 0;
    }

    .info-box li {
      color: #1e3a8a;
      padding: 4px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .status {
      text-align: center;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: 500;
    }

    .status.loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status.success {
      background: #d1fae5;
      color: #065f46;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .error-message {
      display: none;
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .control-panel {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .control-panel h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #555;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Courier New', monospace;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f43f5e 0%, #dc2626 100%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(244, 63, 94, 0.4);
    }

    .pipeline-status {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .pipeline-status.stopped {
      background: #f3f4f6;
      color: #6b7280;
    }

    .pipeline-status.starting {
      background: #fef3c7;
      color: #92400e;
    }

    .pipeline-status.running {
      background: #d1fae5;
      color: #065f46;
    }

    .pipeline-status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.stopped {
      background: #9ca3af;
      animation: none;
    }

    .status-indicator.running {
      background: #10b981;
    }

    .status-indicator.error {
      background: #ef4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .config-display {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .config-display.show {
      display: block;
    }

    .config-display h4 {
      color: #374151;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .config-display p {
      color: #6b7280;
      font-size: 0.85rem;
      margin: 5px 0;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8rem;
      }

      .player-section, .control-panel {
        padding: 20px;
      }

      .button-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéµ Live Stream with Custom Audio Processing</h1>
      <p class="subtitle">Multi-Process Pipeline Demo with SRS Integration</p>
    </header>

    <!-- Control Panel -->
    <div class="control-panel">
      <h2>üéõÔ∏è Pipeline Control</h2>
      
      <div class="pipeline-status stopped" id="pipeline-status">
        <span class="status-indicator stopped" id="status-indicator"></span>
        <span id="status-text">Pipeline Stopped</span>
      </div>

      <div class="form-group">
        <label for="source-url">Source HLS URL</label>
        <input 
          type="text" 
          id="source-url" 
          placeholder="https://example.com/stream.m3u8"
          value="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"
        >
      </div>

      <div class="form-group">
        <label for="srs-rtmp-url">SRS RTMP Output URL</label>
        <input 
          type="text" 
          id="srs-rtmp-url" 
          placeholder="rtmp://localhost/live/processed"
          value="rtmp://localhost/live/processed"
        >
      </div>

      <div class="button-group">
        <button class="btn btn-primary" id="start-btn" onclick="startPipeline()">
          ‚ñ∂Ô∏è Start Pipeline
        </button>
        <button class="btn btn-danger" id="stop-btn" onclick="stopPipeline()" disabled>
          ‚èπÔ∏è Stop Pipeline
        </button>
      </div>

      <div class="config-display" id="config-display">
        <h4>Current Configuration:</h4>
        <p><strong>Source:</strong> <span id="config-source"></span></p>
        <p><strong>Output:</strong> <span id="config-output"></span></p>
        <p><strong>Sample Rate:</strong> <span id="config-samplerate"></span> Hz</p>
        <p><strong>Channels:</strong> <span id="config-channels"></span></p>
      </div>
    </div>

    <div class="info-box">
      <h3>üì° Stream Endpoints</h3>
      <ul>
        <li><strong>HLS:</strong> http://localhost:8080/live/processed.m3u8</li>
        <li><strong>RTMP:</strong> rtmp://localhost/live/processed</li>
      </ul>
    </div>

    <div class="player-section">
      <h2>
        HLS Player
        <span class="badge badge-info">Wide Compatibility</span>
      </h2>
      <p class="player-description">
        Works on all devices and browsers. Latency typically 6-10 seconds.
      </p>
      <div id="hls-status" class="status loading">Initializing HLS player...</div>
      <video id="hls-video" controls></video>
      <div id="hls-error" class="error-message"></div>
    </div>
  </div>

  <!-- HLS.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>

  <script>
    // Configuration
    const HLS_URL = 'http://localhost:8080/live/processed.m3u8';
    const API_BASE = window.location.origin;

    // Global HLS instance
    let hls = null;
    let statusPollInterval = null;

    // UI Elements
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const sourceUrlInput = document.getElementById('source-url');
    const srsRtmpUrlInput = document.getElementById('srs-rtmp-url');
    const pipelineStatus = document.getElementById('pipeline-status');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const configDisplay = document.getElementById('config-display');
    const hlsVideo = document.getElementById('hls-video');
    const hlsStatus = document.getElementById('hls-status');
    const hlsError = document.getElementById('hls-error');

    /**
     * Start the pipeline
     */
    async function startPipeline() {
      const sourceUrl = sourceUrlInput.value.trim();
      const srsRtmpUrl = srsRtmpUrlInput.value.trim();

      if (!sourceUrl || !srsRtmpUrl) {
        alert('Please fill in both URLs');
        return;
      }

      try {
        // Update UI
        startBtn.disabled = true;
        updatePipelineStatus('starting', 'Starting pipeline...');

        // Call API
        const response = await fetch(`${API_BASE}/api/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceUrl, srsRtmpUrl })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to start pipeline');
        }

        // Success
        updatePipelineStatus('running', 'Pipeline Running');
        stopBtn.disabled = false;
        sourceUrlInput.disabled = true;
        srsRtmpUrlInput.disabled = true;

        // Show config
        if (data.config) {
          document.getElementById('config-source').textContent = data.config.sourceUrl;
          document.getElementById('config-output').textContent = data.config.srsRtmpUrl;
          document.getElementById('config-samplerate').textContent = data.config.sampleRate;
          document.getElementById('config-channels').textContent = data.config.channels;
          configDisplay.classList.add('show');
        }

        // Start status polling
        startStatusPolling();

        // Initialize HLS player after a short delay to let SRS start
        setTimeout(() => {
          initHlsPlayer();
        }, 3000);

      } catch (error) {
        console.error('[UI] Start error:', error);
        alert(`Failed to start pipeline: ${error.message}`);
        updatePipelineStatus('error', `Error: ${error.message}`);
        startBtn.disabled = false;
      }
    }

    /**
     * Stop the pipeline
     */
    async function stopPipeline() {
      try {
        stopBtn.disabled = true;
        updatePipelineStatus('stopped', 'Stopping pipeline...');

        // Stop HLS player
        if (hls) {
          hls.destroy();
          hls = null;
        }

        // Call API
        const response = await fetch(`${API_BASE}/api/stop`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to stop pipeline');
        }

        // Success
        updatePipelineStatus('stopped', 'Pipeline Stopped');
        startBtn.disabled = false;
        sourceUrlInput.disabled = false;
        srsRtmpUrlInput.disabled = false;
        configDisplay.classList.remove('show');

        // Stop status polling
        stopStatusPolling();

        // Reset HLS player status
        hlsStatus.textContent = 'Waiting for pipeline to start...';
        hlsStatus.className = 'status loading';
        hlsError.style.display = 'none';

      } catch (error) {
        console.error('[UI] Stop error:', error);
        alert(`Failed to stop pipeline: ${error.message}`);
        updatePipelineStatus('error', `Error: ${error.message}`);
        stopBtn.disabled = false;
      }
    }

    /**
     * Update pipeline status UI
     */
    function updatePipelineStatus(state, text) {
      pipelineStatus.className = `pipeline-status ${state}`;
      statusIndicator.className = `status-indicator ${state}`;
      statusText.textContent = text;
    }

    /**
     * Start polling for pipeline status
     */
    function startStatusPolling() {
      if (statusPollInterval) return;
      
      statusPollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE}/api/status`);
          const data = await response.json();

          if (data.isRunning) {
            updatePipelineStatus('running', 'Pipeline Running');
            stopBtn.disabled = false;
            startBtn.disabled = true;
          } else {
            updatePipelineStatus('stopped', 'Pipeline Stopped');
            stopBtn.disabled = true;
            startBtn.disabled = false;
            stopStatusPolling();
          }
        } catch (error) {
          console.error('[UI] Status poll error:', error);
        }
      }, 2000);
    }

    /**
     * Stop polling for pipeline status
     */
    function stopStatusPolling() {
      if (statusPollInterval) {
        clearInterval(statusPollInterval);
        statusPollInterval = null;
      }
    }

    /**
     * Initialize HLS player
     */
    function initHlsPlayer() {
      if (Hls.isSupported()) {
        try {
          hls = new Hls({
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 90
          });

          hls.loadSource(HLS_URL);
          hls.attachMedia(hlsVideo);

          hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
            console.log('[HLS] Manifest parsed:', data);
            hlsStatus.textContent = `Connected - ${data.levels.length} quality level(s)`;
            hlsStatus.className = 'status success';
            
            hlsVideo.play().catch(e => {
              console.log('[HLS] Autoplay prevented:', e);
              hlsStatus.textContent = 'Ready - Click play to start';
            });
          });

          hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('[HLS] Error:', data);
            
            if (data.fatal) {
              hlsStatus.textContent = `Fatal Error: ${data.type}`;
              hlsStatus.className = 'status error';
              hlsError.textContent = `${data.type}: ${data.details}`;
              hlsError.style.display = 'block';

              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  console.log('[HLS] Network error, trying to recover...');
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  console.log('[HLS] Media error, trying to recover...');
                  hls.recoverMediaError();
                  break;
                default:
                  console.log('[HLS] Fatal error, cannot recover');
                  hls.destroy();
                  break;
              }
            }
          });

        } catch (error) {
          console.error('[HLS] Setup error:', error);
          hlsStatus.textContent = 'Failed to initialize HLS player';
          hlsStatus.className = 'status error';
          hlsError.textContent = error.message;
          hlsError.style.display = 'block';
        }
      } else if (hlsVideo.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        hlsVideo.src = HLS_URL;
        hlsVideo.addEventListener('loadedmetadata', () => {
          hlsStatus.textContent = 'Connected (Native HLS)';
          hlsStatus.className = 'status success';
          hlsVideo.play().catch(e => {
            console.log('[HLS] Autoplay prevented:', e);
          });
        });
        hlsVideo.addEventListener('error', (e) => {
          hlsStatus.textContent = 'Playback error';
          hlsStatus.className = 'status error';
          hlsError.textContent = hlsVideo.error?.message || 'Unknown error';
          hlsError.style.display = 'block';
        });
      } else {
        hlsStatus.textContent = 'HLS is not supported in this browser';
        hlsStatus.className = 'status error';
      }
    }

    // Check initial status on page load
    (async function() {
      try {
        const response = await fetch(`${API_BASE}/api/status`);
        const data = await response.json();

        if (data.isRunning && data.config) {
          // Pipeline is already running
          updatePipelineStatus('running', 'Pipeline Running');
          stopBtn.disabled = false;
          startBtn.disabled = true;
          sourceUrlInput.disabled = true;
          srsRtmpUrlInput.disabled = true;
          sourceUrlInput.value = data.config.sourceUrl;
          srsRtmpUrlInput.value = data.config.srsRtmpUrl;

          document.getElementById('config-source').textContent = data.config.sourceUrl;
          document.getElementById('config-output').textContent = data.config.srsRtmpUrl;
          document.getElementById('config-samplerate').textContent = data.config.sampleRate;
          document.getElementById('config-channels').textContent = data.config.channels;
          configDisplay.classList.add('show');

          startStatusPolling();
          initHlsPlayer();
        }
      } catch (error) {
        console.error('[UI] Initial status check failed:', error);
      }
    })();
  </script>
</body>
</html>

